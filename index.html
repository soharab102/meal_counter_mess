<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mess Meal Cost Calculator</title>

<style>
body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; padding:20px; }
h1 { text-align:center; }
.card { background:#fff; padding:16px; margin-bottom:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#f0f2f8; }
input { padding:6px; width:100%; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; }
button { padding:8px 12px; background:#2b6ef6; color:#fff; border:none; border-radius:6px; cursor:pointer; }
button:hover { background:#1746a2; }
.row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
.row > div { flex:1; min-width:120px; }
.reset-btn { background:#dc2626; }
.reset-btn:hover { background:#a11212; }
</style>
</head>

<body>

<h1>Mess Meal Cost Calculator</h1>

<!-- SETUP SCREEN -->
<div class="card" id="setupCard">
  <h2>Mess Setup</h2>
  <div class="row">
    <div><input type="number" id="totalMembers" placeholder="Total Members" min="1"></div>
    <div><button onclick="createMemberInputs()">Next</button></div>
  </div>
  <div id="memberInputs"></div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none;">

<!-- SHOPPING -->
<div class="card">
<h2>Shopping Records</h2>
<form id="shoppingForm">
  <div class="row">
    <div><input type="date" id="shopDate" required></div>
    <div><input type="number" id="shopAmount" placeholder="Amount (Tk)" required></div>
    <div><input type="text" id="shopNote" placeholder="Note"></div>
    <div><button>Add</button></div>
  </div>
</form>
<table id="shoppingTable">
<thead><tr><th>Date</th><th>Amount</th><th>Note</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</div>

<!-- MEALS -->
<div class="card">
<h2>Meal Records</h2>
<form id="mealForm">
<div class="row">
  <div><input type="date" id="mealDate" required></div>
  <div><button>Add Meals</button></div>
</div>
<table>
<thead><tr><th>Member</th><th>Meals</th></tr></thead>
<tbody id="mealInputs"></tbody>
</table>
</form>

<table id="mealTable">
<thead></thead>
<tbody></tbody>
</table>
</div>

<!-- CALCULATION -->
<div class="card">
<h2>Calculation</h2>
<button id="calcBtn">Calculate</button>
<button id="resetBtn" class="reset-btn">New Month</button>
<div id="results"></div>
</div>

</div>

<script>
let members = JSON.parse(localStorage.getItem('members') || '[]');
let shopping = JSON.parse(localStorage.getItem('shopping') || '[]');
let meals = JSON.parse(localStorage.getItem('meals') || '[]');

const shoppingTable = document.querySelector('#shoppingTable tbody');
const mealInputs = document.getElementById('mealInputs');
const mealTable = document.querySelector('#mealTable tbody');
const results = document.getElementById('results');

function createMemberInputs(){
  const total = +totalMembers.value;
  if(!total) return alert("Enter total members");
  memberInputs.innerHTML = '';
  for(let i=0;i<total;i++){
    memberInputs.innerHTML += `<input placeholder="Member ${i+1} name" style="margin-bottom:6px">`;
  }
  memberInputs.innerHTML += `<button onclick="saveMembers()">Start</button>`;
}

function saveMembers(){
  members = [];
  document.querySelectorAll('#memberInputs input').forEach(i=>{
    if(i.value.trim()) members.push(i.value.trim());
  });
  if(!members.length) return alert("Enter names");
  localStorage.setItem('members', JSON.stringify(members));
  setupCard.style.display='none';
  mainApp.style.display='block';
  renderMealInputs();
  renderMealHeader();
}

function renderMealInputs(){
  mealInputs.innerHTML='';
  members.forEach((m,i)=>{
    mealInputs.innerHTML += `
      <tr>
        <td>${m} <button onclick="editName(${i})">✏️</button></td>
        <td><input type="number" min="0" id="meal_${i}"></td>
      </tr>`;
  });
}

function editName(i){
  const n = prompt("Edit name", members[i]);
  if(n){
    members[i]=n;
    localStorage.setItem('members', JSON.stringify(members));
    renderMealInputs();
    renderMealHeader();
    renderMeals();
  }
}

shoppingForm.onsubmit = e=>{
  e.preventDefault();
  shopping.push({date:shopDate.value, amount:+shopAmount.value, note:shopNote.value});
  localStorage.setItem('shopping',JSON.stringify(shopping));
  renderShopping();
  shoppingForm.reset();
};

mealForm.onsubmit = e=>{
  e.preventDefault();
  let m={date:mealDate.value,data:{}};
  members.forEach((_,i)=>m.data[i]=+document.getElementById(`meal_${i}`).value||0);
  meals.push(m);
  localStorage.setItem('meals',JSON.stringify(meals));
  renderMeals();
  mealForm.reset();
};

function renderShopping(){
  shoppingTable.innerHTML='';
  shopping.forEach((s,i)=>{
    shoppingTable.innerHTML+=`<tr><td>${s.date}</td><td>${s.amount}</td><td>${s.note}</td>
    <td><button onclick="shopping.splice(${i},1);renderShopping()">Del</button></td></tr>`;
  });
}

function renderMealHeader(){
  let h='<tr><th>Date</th>';
  members.forEach(m=>h+=`<th>${m}</th>`);
  h+='<th>Action</th></tr>';
  document.querySelector('#mealTable thead').innerHTML=h;
}

function renderMeals(){
  mealTable.innerHTML='';
  meals.forEach((m,i)=>{
    let r=`<tr><td>${m.date}</td>`;
    members.forEach((_,x)=>r+=`<td>${m.data[x]}</td>`);
    r+=`<td><button onclick="meals.splice(${i},1);renderMeals()">Del</button></td></tr>`;
    mealTable.innerHTML+=r;
  });
}

calcBtn.onclick = () => {
  let totalCost = 0;
  shopping.forEach(s => {
    totalCost += Number(s.amount);
  });

  // Total meals per member
  let totals = new Array(members.length).fill(0);

  meals.forEach(m => {
    members.forEach((_, i) => {
      totals[i] += Number(m.data[i] || 0);
    });
  });

  const totalMeals = totals.reduce((a, b) => a + b, 0);
  const rate = totalMeals > 0 ? totalCost / totalMeals : 0;

  let html = `
    <p><b>Total Cost:</b> ${totalCost.toFixed(2)} Tk</p>
    <p><b>Total Meals:</b> ${totalMeals}</p>
    <p><b>Meal Rate:</b> ${rate.toFixed(2)} Tk / meal</p>
    <table>
      <tr>
        <th>Member</th>
        <th>Total Meals</th>
        <th>Cost (Tk)</th>
      </tr>
  `;

  members.forEach((m, i) => {
    html += `
      <tr>
        <td>${m}</td>
        <td>${totals[i]}</td>
        <td>${(totals[i] * rate).toFixed(2)}</td>
      </tr>
    `;
  });

  html += `</table>`;
  results.innerHTML = html;
};


resetBtn.onclick=()=>{
  if(confirm("Clear all data?")){
    localStorage.clear();
    location.reload();
  }
};

if(members.length){
  setupCard.style.display='none';
  mainApp.style.display='block';
  renderMealInputs();
  renderMealHeader();
}
renderShopping();
renderMeals();
</script>

</body>
</html>
